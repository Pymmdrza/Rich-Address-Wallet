name: Main Updater

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  litecoin_updater:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Litecoin Updater
        id: start_litecoin
        run: |
          response=$(curl -s -X POST -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/litecoin_updater.yml/dispatches \
          -d '{"ref": "main"}')

          echo "Litecoin workflow triggered, waiting for completion..."
          
          while true; do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | jq -r '.workflow_runs[] | select(.name=="Litecoin Updater") | .status' | head -n 1)

            if [[ "$status" == "completed" ]]; then
              echo "Litecoin update completed."
              break
            else
              echo "Waiting for Litecoin updater to finish..."
              sleep 30
            fi
          done

      - name: Save Litecoin Update Time
        run: echo "LITECOIN=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

  dogecoin_updater:
    runs-on: ubuntu-latest
    needs: litecoin_updater
    steps:
      - name: Trigger Dogecoin Updater
        run: |
          response=$(curl -s -X POST -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/dogecoin_updater.yml/dispatches \
          -d '{"ref": "main"}')

          echo "Dogecoin workflow triggered, waiting for completion..."
          
          while true; do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | jq -r '.workflow_runs[] | select(.name=="Dogecoin Updater") | .status' | head -n 1)

            if [[ "$status" == "completed" ]]; then
              echo "Dogecoin update completed."
              break
            else
              echo "Waiting for Dogecoin updater to finish..."
              sleep 30
            fi
          done

      - name: Save Dogecoin Update Time
        run: echo "DOGECOIN=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

  bitcoincash_updater:
    runs-on: ubuntu-latest
    needs: dogecoin_updater
    steps:
      - name: Trigger Bitcoin Cash Updater
        run: |
          response=$(curl -s -X POST -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/bitcoincash_updater.yml/dispatches \
          -d '{"ref": "main"}')

          echo "Bitcoin Cash workflow triggered, waiting for completion..."
          
          while true; do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | jq -r '.workflow_runs[] | select(.name=="Bitcoin Cash Updater") | .status' | head -n 1)

            if [[ "$status" == "completed" ]]; then
              echo "Bitcoin Cash update completed."
              break
            else
              echo "Waiting for Bitcoin Cash updater to finish..."
              sleep 30
            fi
          done

      - name: Save Bitcoin Cash Update Time
        run: echo "BITCOINCASH=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

  bitcoin_updater:
    runs-on: ubuntu-latest
    needs: bitcoincash_updater
    steps:
      - name: Trigger Bitcoin Updater
        run: |
          response=$(curl -s -X POST -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/bitcoin_updater.yml/dispatches \
          -d '{"ref": "main"}')

          echo "Bitcoin workflow triggered, waiting for completion..."
          
          while true; do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | jq -r '.workflow_runs[] | select(.name=="Bitcoin Updater") | .status' | head -n 1)

            if [[ "$status" == "completed" ]]; then
              echo "Bitcoin update completed."
              break
            else
              echo "Waiting for Bitcoin updater to finish..."
              sleep 30
            fi
          done

      - name: Save Bitcoin Update Time
        run: echo "BITCOIN=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

  update_readme:
    runs-on: ubuntu-latest
    needs: bitcoin_updater
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Load Update Times
        run: |
          export UPDATE_TIME_LITECOIN=${LITECOIN}
          export UPDATE_TIME_DOGECOIN=${DOGECOIN}
          export UPDATE_TIME_BITCOINCASH=${BITCOINCASH}
          export UPDATE_TIME=${BITCOIN}
          envsubst < .github/README.template.md > README.md

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add README.md
          git commit -m "Updated README with latest coin update times"
          git push origin main
